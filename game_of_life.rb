#!/usr/bin/env ruby

require 'optparse'
require './gol'

# Default options
options = {pattern: 'gosper_gun', ticks: 100}

opt_parser = OptionParser.new do |opt|
  opt.banner = "Usage: game_of_life [OPTIONS]"
  opt.separator  ""
  opt.separator  "Options"

  opt.on("-f","--file FILE", "File containing a pattern you want to run.") do |file|
    options[:file] = file
  end

  opt.on("-p","--pattern PATTERN", "Which pattern you want to run. Default: gosper_gun") do |pattern|
    options[:pattern] = pattern
  end

  opt.on("-t","--ticks TICKS", "Number of iterations or 'ticks' you want to run. Default: 100") do |ticks|
    options[:ticks] = ticks.to_i
  end

  opt.on("-h","--help","help") do
    puts opt_parser
    exit
  end
end

opt_parser.parse!


# Load pattern file, or fallback to inline
if options[:file]
  pattern = IO.read(options[:file])
else
  # Read DATA from end of file into a Hash (Sinatra inline-template style with '@@' for titles)
  patterns = DATA.read.split(/^@@\s*(.*\S)\s*$/).map(&:strip).delete_if{ |d| d == '' }
  patterns = Hash[*patterns]
  pattern = patterns[options[:pattern]]
end

# Run the game if the pattern exists
if pattern
  ticks = options[:ticks]
  grid = Grid.new(pattern)

  0.upto(ticks) do |i|
    system('clear')
    puts grid.inspect
    puts "Iteration: #{i}"
    sleep 0.05
    grid.tick!
  end
else
  raise "Not a valid pattern!"
end



__END__

@@gosper_gun
................................................................................
................................................................................
................................................................................
..............................X.................................................
.............................X.X................................................
............XX...............XX.X...............................................
............X.X..............XX.XX...XX.........................................
.......XX......X.............XX.X....XX.........................................
...XX.X..X..X..X.............X.X................................................
...XX..XX......X........X.....X.................................................
............X.X.......X.X.......................................................
............XX.........XX.......................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
